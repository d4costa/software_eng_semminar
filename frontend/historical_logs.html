<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="base.css" />
    <title>Historical Records</title>
    <style>
      .records-container {
        width: 95%;
        margin: 20px auto;
        overflow-x: auto;
      }

      .records-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .records-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .records-table th,
      .records-table td {
        border: 1px solid #ddd;
        padding: 12px 15px;
        text-align: left;
      }

      .records-table th {
        background-color: #2c3e50;
        color: white;
        position: sticky;
        top: 0;
      }

      .records-table tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      .records-table tr:hover {
        background-color: #e9ecef;
      }

      .status-checkin {
        color: #28a745;
        font-weight: bold;
        background-color: rgba(40, 167, 69, 0.1);
        padding: 3px 8px;
        border-radius: 4px;
      }

      .status-checkout {
        color: #dc3545;
        font-weight: bold;
        background-color: rgba(220, 53, 69, 0.1);
        padding: 3px 8px;
        border-radius: 4px;
      }

      .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }

      .refresh-btn {
        background-color: #17a2b8;
        color: white;
      }

      .refresh-btn:hover {
        background-color: #138496;
      }

      .back-btn {
        background-color: #6c757d;
        color: white;
        margin-right: 10px;
      }

      .back-btn:hover {
        background-color: #5a6268;
      }

      .last-log-container {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-left: 4px solid #17a2b8;
        margin-bottom: 20px;
        border-radius: 4px;
      }

      .last-log-label {
        font-weight: bold;
        color: #2c3e50;
      }

      @media (max-width: 768px) {
        .records-table {
          display: block;
          overflow-x: auto;
        }

        .records-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .btn-group {
          margin-top: 10px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header">
        <div class="logo-container">
          <img
            src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQsXSB6f7fXdH8FCkqzKq6KVUVq6KWJnwx1Xg&s"
            alt="Escudo Universidad Distrital"
          />
        </div>
        <div class="user-container">
          <span class="user-name" id="userName"></span>
          <button class="logout-btn" id="logoutBtn">
            Salir
            <img
              src="https://cdn-icons-png.flaticon.com/512/59/59399.png"
              alt="Icono Salir"
            />
          </button>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="records-container">
        <div class="records-header">
          <h2>Historical Records</h2>
          <div class="btn-group">
            <button class="action-btn back-btn" id="backBtn">Back</button>
            <button class="action-btn refresh-btn" id="refreshBtn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                viewBox="0 0 16 16"
                style="margin-right: 5px"
              >
                <path
                  d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"
                />
                <path
                  fill-rule="evenodd"
                  d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"
                />
              </svg>
              Refresh
            </button>
          </div>
        </div>

        <div class="last-log-container" id="lastLog">
          <span class="last-log-label">Last record:</span> Loading...
        </div>

        <table class="records-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Event Type</th>
              <th>Parking</th>

              <th>Chassis Code</th>
            </tr>
          </thead>
          <tbody id="recordsBody">
            <!-- Los registros se llenarán dinámicamente con JavaScript -->
            <tr>
              <td colspan="9" style="text-align: center">Loading records...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <script>
      // Mostrar nombre de usuario desde localStorage
      const nombre = localStorage.getItem("nombre");
      const apellido = localStorage.getItem("apellido");
      const userId = localStorage.getItem("userId");
      document.getElementById("userName").textContent = `${nombre} ${apellido}`;

      // Manejador de logout
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async function () {
          try {
            const response = await fetch(
              "http://localhost:8080/usuario/logout",
              {
                method: "GET",
              }
            );

            if (!response.ok) {
              console.warn("Logout request failed:", response.status);
            }
          } catch (error) {
            console.error("Logout error:", error);
          } finally {
            localStorage.clear();
            window.location.href = "/login.html";
          }
        });

      // Botón para volver atrás
      document.getElementById("backBtn").addEventListener("click", function () {
        window.history.back();
      });

      // Función para formatear fecha
      function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return { date: "N/A", time: "N/A" };

        const date = new Date(dateTimeStr);
        const optionsDate = { year: "numeric", month: "short", day: "numeric" };
        const optionsTime = {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        };

        return {
          date: date.toLocaleDateString(undefined, optionsDate),
          time: date.toLocaleTimeString(undefined, optionsTime),
        };
      }

      // Función para cargar los registros
      async function loadRecords() {
        try {
          // Mostrar estado de carga
          document.getElementById("recordsBody").innerHTML = `
            <tr>
              <td colspan="9" style="text-align: center;">
                <div style="display: inline-block; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;"></div>
                Loading records...
              </td>
            </tr>
          `;

          // Obtener el último registro
          const lastLogResponse = await fetch(
            `http://localhost:8080/GetLastLog?userId=${userId}`
          );
          if (lastLogResponse.ok) {
            var lastLog = await lastLogResponse.text();
            if (lastLog == "checkin") {
              lastLog = "check out";
            } else astLog = "check in";
            document.getElementById("lastLog").innerHTML = `
              <span class="last-log-label">Last record:</span> ${
                lastLog || "No records found"
              }
            `;
          }

          // Obtener todos los registros
          const response = await fetch(
            `http://localhost:8080/getAllLogs?userId=${userId}`
          );

          if (response.ok) {
            const logs = await response.json();
            const tableBody = document.getElementById("recordsBody");
            console.log(logs);

            if (logs.length === 0) {
              tableBody.innerHTML = `
                <tr>
                  <td colspan="9" style="text-align: center;">No records found</td>
                </tr>
              `;
              return;
            }

            tableBody.innerHTML = "";

            logs.forEach((log) => {
              const { date, time } = formatDateTime(
                log.timestamp || log.dateTime
              );
              const eventTypeClass =
                log.event_type === "check in"
                  ? "status-checkin"
                  : "status-checkout";

              const row = document.createElement("tr");

              row.innerHTML = `
                <td>${date}</td>
                <td>${time}</td>
                <td><span class="${eventTypeClass}">${
                log.eventType || log.type
              }</span></td>
                <td>${log.parkingName || "N/A"}</td>
                <td>${log.chasisCode || "N/A"}</td>
              `;

              tableBody.appendChild(row);
            });
          } else {
            const errorText = await response.text();
            tableBody.innerHTML = `
              <tr>
                <td colspan="9" style="text-align: center; color: #dc3545;">
                  Error loading records: ${errorText || response.status}
                </td>
              </tr>
            `;
          }
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("recordsBody").innerHTML = `
            <tr>
              <td colspan="9" style="text-align: center; color: #dc3545;">
                Connection error: ${error.message}
              </td>
            </tr>
          `;
        }
      }

      // Cargar registros al iniciar
      document.addEventListener("DOMContentLoaded", loadRecords);

      // Botón para refrescar registros
      document
        .getElementById("refreshBtn")
        .addEventListener("click", loadRecords);
    </script>
  </body>
</html>
